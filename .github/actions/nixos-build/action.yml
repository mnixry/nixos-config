name: NixOS Build
description: Build NixOS system closure with caching

inputs:
  nix-cache-uri:
    description: The URI of the Nix cache
    required: true
  aws-secret-access-key:
    description: The AWS secret access key
    required: true
  aws-access-key-id:
    description: The AWS access key ID
    required: true
  nix-sign-secret-key:
    description: The Nix sign secret key
    required: true

runs:
  using: "composite"
  steps:
    - name: Apply Nix Settings
      shell: bash
      run: |
        nix build .#nix-conf
        cat ./result | sudo tee -a /etc/nix/nix.custom.conf
        sudo systemctl restart nix-daemon.service
    - name: Write Cache Credentials
      id: write-cache-credentials
      shell: bash
      env:
        NIX_CACHE_URI: ${{ inputs.nix-cache-uri }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws-secret-access-key }}
        AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key-id }}
        NIX_SIGN_SECRET_KEY: ${{ inputs.nix-sign-secret-key }}
      run: |
        ${GITHUB_ACTION_PATH}/credentials.py
    - name: Run Nix Build
      shell: bash
      env:
        POST_BUILD_HOOK: ${{ steps.write-cache-credentials.outputs.post-build-hook }}
      run: |
        nix build ".#toplevel" \
          --fallback \
          --print-build-logs \
          --option post-build-hook "${POST_BUILD_HOOK}"
